---
// Get the `id`, `title`, and `prompt` props passed to this component
const { id, title = "Try it out: Image generation", prompt = "" } = Astro.props;

// Ensure an ID is provided to prevent errors
if (!id) {
    throw new Error('The `id` prop is required for this component.');
}
---

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<script define:vars={{ id }}>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById(id);
    if (!container) {
        console.error('Component container not found.');
        return;
    }

    const generateBtn = container.querySelector(`#generateBtn-${id}`);
    const promptInput = container.querySelector(`#promptInput-${id}`);
    const aiImage = container.querySelector(`#aiImage-${id}`);
    const placeholderText = container.querySelector(`#placeholderText-${id}`);
    const loadingSpinner = container.querySelector(`#loadingSpinner-${id}`);
    
    const generateImage = async () => {
        const prompt = promptInput.value.trim();
        if (!prompt) return;
        
        placeholderText.classList.add('hidden');
        aiImage.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        try {
            // Pollinations image API returns the image directly.
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true&private=true`;
            
            // Set the image src directly
            aiImage.src = url;
            
            // Listen for the image to load to hide the spinner
            aiImage.onload = () => {
                loadingSpinner.classList.add('hidden');
                aiImage.classList.remove('hidden');
            };
            
            // Handle image load errors
            aiImage.onerror = () => {
                loadingSpinner.classList.add('hidden');
                placeholderText.textContent = 'Failed to generate image. Please try again.';
                placeholderText.classList.remove('hidden');
            };

        } catch (error) {
            console.error('Error fetching image:', error);
            loadingSpinner.classList.add('hidden');
            placeholderText.textContent = 'Failed to generate image. Please try again.';
            placeholderText.classList.remove('hidden');
        }
    };

    // Check if elements exist before adding event listeners
    if (generateBtn && promptInput) {
        // Click event for the button
        generateBtn.addEventListener('click', generateImage);

        // Keydown event for the input field to trigger on "Enter"
        promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent the default form submission behavior
                generateImage();
            }
        });
    }
});
</script>
<div id={id}>
    <main class="w-full mb-8 overflow-hidden bg-gray-50">
        <div class="px-4 py-2 text-left text-gray-500 font-mono bg-gray-100">
            {title}
        </div>
        <div class="p-4 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
            <!-- Left Column: Input Prompt and Generate Button -->
            <div class="flex flex-col md:w-1/2">
                <label for={`promptInput-${id}`} class="text-gray-700 font-semibold mb-2">Enter your prompt:</label>
                <textarea id={`promptInput-${id}`} placeholder="Enter your prompt here..." class=" h-32 p-3 border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">{prompt}</textarea>
                
                <button id={`generateBtn-${id}`} class="mt-4 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out">
                    Generate Image
                </button>
            </div>
            
            <!-- Right Column: AI Response -->
            <div class="md:w-1/2">
                <div class="flex items-center text-gray-700 font-semibold mb-2">
                    <span class="mr-2">üñºÔ∏è</span> AI Image
                </div>
                <div id={`imageContainer-${id}`} class="flex justify-center items-center h-96 border border-gray-300 bg-gray-200 text-gray-800 overflow-hidden relative p-4 text-left">
                    <p id={`placeholderText-${id}`} class="text-gray-500 text-center">Your generated image will appear here.</p>
                    <img id={`aiImage-${id}`} class="hidden w-full h-full object-contain" src="#" alt="Generated AI Image" />
                    <div id={`loadingSpinner-${id}`} class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
                    </div>
                </div>  
            </div>
        </div>
        <div class="px-4 py-2 text-base text-right text-gray-400">
            Free API provided by <a href="https://pollinations.ai/" target="_blank">pollinations.ai</a>. If you experience errors, try different prompts or try again later.
        </div>
    </main>
</div>
